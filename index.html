<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG & Timesheet Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        // Enable dark mode based on class
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* === Base & Layout === */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        main {
            height: 100vh;
        }

        .settings-content {
            flex-grow: 1;
            min-width: 0; /* Prevents content from overflowing in a flex container */
        }

        /* === Components === */

        /* --- Main Navigation & Settings Links (Combined) --- */
        .nav-link,
        .settings-link {
            transition: all 0.2s ease-in-out;
        }

        /* Default state for vertical links */
        .settings-link {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #8a9098; /* text-gray-700 */
        }

        /* Active & Hover States */
        .nav-link.active, .nav-link:hover,
        .settings-link.active, .settings-link:not(.active):hover {
            background-color: #e0f2fe; /* light sky-100 */
            color: #0284c7; /* sky-600 */
        }

        /* Dark Mode Active & Hover States */
        .dark .nav-link.active, .dark .nav-link:hover,
        .dark .settings-link.active, .dark .settings-link:not(.active):hover {
            background-color: #0c4a6e; /* sky-900 */
            color: #e0f2fe; /* sky-100 */
        }

        /* --- Settings Sidebar --- */
        #settings-sidebar {
            width: 100%; /* Default width for large screens */
            top: 0px; /* Adjust this to match your header's height */
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #111827;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; /* Smooth transition */
        }

        #sidebar {
            transition: transform 0.3s ease-in-out; /* For mobile slide-out */
        }

        /* --- Charts --- */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }

        #chart-toggles {
            display: flex;
            flex-wrap: wrap;
        }

        .chart-toggle {
            cursor: pointer;
        }

        #chart-toggles .chart-toggle.active {
            font-weight: 600;
            background-color: #e0f2fe;
            color: #0284c7;
        }

        /* --- Forms & Inputs --- */
        input[type="text"], input[type="email"], input[type="password"],
        input[type="number"], input[type="search"], input[type="tel"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #ffffff;
            font-size: 0.9rem;
            color: #111827;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus,input[type="date"]:focus,input[type="month"]:focus,
        input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        ::placeholder {
            color: #9ca3af;
            opacity: 1;
        }

        #password-criteria li {
            transition: color 0.3s ease-in-out;
        }

        /* --- Modals & Toasts --- */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }

        .toast {
            animation: slideIn 0.3s ease-in-out, fadeOut 0.5s ease-in-out 2.5s forwards;
        }

        /* === Animations === */
        .section {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* === Utilities & Print === */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }

        /* === Responsive Overrides for Small Screens === */
        @media (max-width: 960px) {
            /* Shrink the sidebar */
            #settings-sidebar {
                position: sticky;
                top: 70px;
                width: auto;
                padding: 5px;

            }
            
            /* Hide the text label in the links */
            .link-text {
                display: none;
            }

            /* Style links as icon-only buttons */
            .settings-link {
                justify-content: center;
                width: 50px;
                height: 50px;
                position: relative; /* Needed for tooltip positioning */
            }

            /* Remove icon margin when text is hidden */
            .settings-link i {
                margin-right: 0;
            }
            
            /* Create and style the tooltip that appears on hover */
            .settings-link::after {
                content: attr(data-tooltip);
                position: absolute;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }

            .settings-link:hover::after {
                bottom: 125%; /* Position it above the icon */
                left: 50%;
                transform: translateX(-50%);
                background-color: #1f2937;
                color: #ffffff;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 14px;
                white-space: nowrap;
                z-index: 10;
                opacity: 1;
                visibility: visible;
                transition: opacity 0.2s ease;
                overflow: visible;
            }
        }

        /* --- Global Tooltip Styling --- */
        #global-tooltip {
            /* Use 'fixed' to position relative to the screen, ignoring parents */
            position: fixed;
            
            /* Visuals */
            background-color: #1f2937; /* Dark background */
            color: #ffffff; /* White text */
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 9999; /* Ensure it's on top of everything */

            /* Initially hidden */
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Can't be interacted with */
            transition: opacity 0.2s ease;
        }

        /* Class to show the tooltip */
        #global-tooltip.show {
            opacity: 1;
            visibility: visible;
        }


        /* --- FIX FOR SETTINGS PAGE OVERLAP --- */


        #section-settings #settings-nav {
            position: sticky;
            /* This value should be the height of your main site header (e.g., 60px) */
            top: 60px; 

            /* This makes the bar opaque so content doesn't show through */
            background-color: #111827; /* Match your dark theme background */
            
            /* This ensures the bar stays on top of the content */
            z-index: 10;
        }

        /* 2. Push down the content area that follows the navigation */
        #section-settings main {
            /* This creates a buffer zone at the top of your content.
            Adjust this value to be a little more than the height of your nav bar.
            */
            padding-top: 80px; 
        }

        .fa-eye-slash:hover {
            color: #0284c7;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-3"></div>

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-lg">Loading Application...</p>
        </div>
    </div>
    
    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-8">
            <div class="text-center mb-8">
                 <h1 class="text-3xl font-bold text-gray-800 dark:text-white"><i class="fas fa-leaf mr-2 text-green-500"></i>ESG Tracker</h1>
                 <p class="text-gray-500 dark:text-gray-400 mt-2">Sign in or create an account to continue</p>
            </div>
            
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium">Email Address</label>
                        <input type="email" id="login-email" required class="mt-1 w-full form-input" autocomplete="email">
                    </div>
                     <div>
                         <div class="flex justify-between items-center">
                            <label for="login-password" class="block text-sm font-medium">Password</label>
                            <a href="#" id="forgot-password-link-login" class="text-sm text-blue-600 hover:text-blue-500">Forgot Password?</a>
                        </div>
                        <input type="password" id="login-password" required class="mt-1 w-full form-input" autocomplete="current-password">
                    </div>
                </div>
                 <p id="auth-error" class="text-red-500 text-sm mt-4 text-center hidden"></p>
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Sign In
                </button>
            </form>
            
            <p class="text-center text-sm text-gray-500 mt-6">
                Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>
            </p>
        </div>
    </div>


    <div id="app-container" class="hidden md:flex h-screen">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0 fixed md:relative h-full z-40 transform -translate-x-full md:translate-x-0">
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <h1 class="text-xl font-bold"><i class="fas fa-leaf mr-2 text-green-500"></i>ESG Tracker</h1>
                 <button id="sidebar-close-btn" class="md:hidden text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                <a href="#" data-section="dashboard" class="nav-link active flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-tachometer-alt w-6 h-6 mr-3"></i>Dashboard
                </a>
                <a href="#" data-section="data-entry" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-edit w-6 h-6 mr-3"></i>Data Entry
                </a>
                 <a href="#" data-section="goals" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-bullseye w-6 h-6 mr-3"></i>Goals
                </a>
                 <a href="#" data-section="documents" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-file-alt w-6 h-6 mr-3"></i>Documents
                </a>
                <a href="#" data-section="timesheet" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-clock w-6 h-6 mr-3"></i>Timesheet
                </a>
                <a href="#" data-section="reports" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-chart-pie w-6 h-6 mr-3"></i>Reports
                </a>
                <a href="#" data-section="settings" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg">
                    <i class="fas fa-cog w-6 h-6 mr-3"></i>Settings
                </a>
            </nav>
            <div class="px-4 py-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                 <p class="text-xs text-gray-500 dark:text-gray-400">Signed in as,</p>
                 <p id="user-display" class="font-medium text-sm truncate">user</p>
                 <button id="logout-btn" class="mt-2 w-full text-left text-sm text-red-500 hover:text-red-700 font-medium">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 w-full overflow-y-auto">
             <!-- Mobile Header -->
            <header class="md:hidden sticky top-0 bg-white dark:bg-gray-800/80 backdrop-blur-sm z-20 flex items-center justify-between p-4 border-b dark:border-gray-700">
                <button id="sidebar-open-btn" class="text-gray-800 dark:text-gray-200">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 class="text-lg font-bold">ESG Tracker</h1>
                <div></div>
            </header>
            
            <div class="p-6 lg:p-8">
            <!-- ESG Dashboard Section -->
            <section id="section-dashboard" class="section">
                <header class="mb-8 flex flex-col md:flex-row justify-between md:items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">ESG Command Center</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-1" id="dashboard-date">Wednesday, 8 October 2025</p>
                    </div>
                    <button id="ai-insights-btn" class="mt-4 md:mt-0 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i>Get AI Insights
                    </button>
                </header>

                <!-- No Data Placeholder -->
                <div id="dashboard-no-data" class="hidden text-center py-16 bg-white dark:bg-gray-800 rounded-xl shadow-md">
                    <i class="fas fa-chart-line fa-3x text-gray-400 dark:text-gray-500"></i>
                    <h3 class="mt-4 text-xl font-semibold text-gray-800 dark:text-gray-200">Welcome to Your ESG Command Center</h3>
                    <p class="mt-2 text-gray-500 dark:text-gray-400">There is no data to display yet. Start by logging your first record.</p>
                    <button id="add-first-record-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                        Add First ESG Record
                    </button>
                </div>
                
                <div id="dashboard-main-content" class="hidden">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Overall ESG Score Card -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Overall ESG Score</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="kpi-esg-score">0</p>
                                <div class="flex items-center text-sm" id="kpi-esg-trend-container">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    <span id="kpi-esg-trend-text">--% vs last quarter</span>
                                </div>
                            </div>
                            <div class="relative w-20 h-20">
                                <canvas id="kpi-esg-chart"></canvas>
                                <div id="kpi-esg-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-blue-500">0%</div>
                            </div>
                        </div>
                        <!-- Energy Consumption Card -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Energy Consumption</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="kpi-energy">0 <span class="text-base font-normal text-gray-500">kWh</span></p>
                                <div class="flex items-center text-sm" id="kpi-energy-trend-container">
                                    <i class="fas fa-arrow-down mr-1"></i>
                                    <span id="kpi-energy-trend-text">--% vs last quarter</span>
                                </div>
                            </div>
                            <div class="relative w-20 h-20">
                                <canvas id="kpi-energy-chart"></canvas>
                                <div id="kpi-energy-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-green-500">0%</div>
                            </div>
                        </div>
                        <!-- Waste Recycled Card -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Waste Recycled</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="kpi-waste">0%</p>
                                <div class="flex items-center text-sm" id="kpi-waste-trend-container">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    <span id="kpi-waste-trend-text">--% vs last quarter</span>
                                </div>
                            </div>
                            <div class="relative w-20 h-20">
                                <canvas id="kpi-waste-chart"></canvas>
                                <div id="kpi-waste-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-yellow-500">0%</div>
                            </div>
                        </div>
                        <!-- Social Compliance Card -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Social Compliance</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="kpi-social">0%</p>
                                <div class="flex items-center text-sm" id="kpi-social-trend-container">
                                    <i class="fas fa-arrow-down mr-1"></i>
                                    <span id="kpi-social-trend-text">--% vs last quarter</span>
                                </div>
                            </div>
                            <div class="relative w-20 h-20">
                                <canvas id="kpi-social-chart"></canvas>
                                <div id="kpi-social-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-purple-500">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Insights & Alerts -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Key Insights & Alerts</h3>
                        <div id="insights-alerts-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Dynamic alerts will be injected here -->
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
                        <!-- Left Side: Main Chart & Recent Activity -->
                        <div class="lg:col-span-3 space-y-6">
                            <!-- Interactive Main Chart -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold">Performance Trends</h3>
                                    <div id="chart-toggles" class="flex space-x-1 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                                        <button data-chart="environmental" class="chart-toggle active px-3 py-1 text-sm font-medium rounded-md">Environmental</button>
                                        <button data-chart="social" class="chart-toggle px-3 py-1 text-sm font-medium rounded-md">Social</button>
                                        <button data-chart="governance" class="chart-toggle px-3 py-1 text-sm font-medium rounded-md">Governance</button>
                                    </div>
                                </div>
                                <div class="h-80"><canvas id="main-dashboard-chart"></canvas></div>
                            </div>
                            
                             <!-- Metric Breakdown -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Latest Month Metric Breakdown</h3>
                                <div class="h-64"><canvas id="metric-breakdown-chart"></canvas></div>
                            </div>
                        </div>

                        <!-- Right Side: Initiatives, Breakdown, News -->
                        <div class="lg:col-span-2 space-y-6">
                             <!-- Goal Progress -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Goal Progress</h3>
                                <div id="goal-progress-container" class="space-y-5">
                                    <!-- Dynamic Goal Progress injected here -->
                                </div>
                            </div>
                            <!-- Industry Benchmark -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Industry Benchmark</h3>
                                <div class="h-64"><canvas id="benchmark-chart"></canvas></div>
                            </div>
                            <!-- ESG News -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">ESG News & Regulatory Updates</h3>
                                <ul id="esg-news-feed" class="space-y-3 text-sm">
                                    <!-- News items injected here -->
                                </ul>
                            </div>
                             <!-- Recent Activity -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Recent Activity</h3>
                                <div id="recent-activity-feed" class="space-y-4">
                                    <!-- Real-time content is injected here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        #chart-toggles .chart-toggle.active {
                            @apply bg-white text-blue-600 shadow-sm dark:bg-gray-800 dark:text-blue-400;
                        }
                    </style>
                </div>
            </section>
            
            <!-- GOALS SECTION -->
            <section id="section-goals" class="section hidden">
                 <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">ESG Goals</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Set and track your sustainability targets.</p>
                    </div>
                    <button id="add-goal-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center">
                        <i class="fas fa-plus mr-2"></i>New Goal
                    </button>
                </header>
                <div id="goals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Goals will be injected here -->
                </div>
            </section>
            
            <!-- DOCUMENTS SECTION -->
            <section id="section-documents" class="section hidden">
                 <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Document Hub</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Manage all your ESG reports and certifications.</p>
                    </div>
                    <button id="upload-doc-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center">
                        <i class="fas fa-upload mr-2"></i>Upload Document
                    </button>
                </header>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Document Name</th>
                                    <th scope="col" class="px-6 py-3">Category</th>
                                    <th scope="col" class="px-6 py-3">Upload Date</th>
                                    <th scope="col" class="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documents-table-body">
                                <!-- Documents will be loaded here from Firestore -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- Data Entry Section -->
            <section id="section-data-entry" class="section hidden">
                 <header class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Log ESG Data</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Enter your new sustainability data for the month.</p>
                </header>
                 <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                    <form id="esg-form" class="space-y-6">
                        <div>
                            <label for="month" class="block text-sm font-medium">Month</label>
                            <input type="month" id="month" required class="mt-1 block w-full form-input">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <!-- Environmental -->
                            <div class="space-y-4 p-4 border rounded-lg border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold text-green-700 dark:text-green-400">Environmental</h3>
                                <div>
                                    <label for="energy" class="block text-sm font-medium">Energy Consumption (kWh)</label>
                                    <input type="number" id="energy" placeholder="e.g., 5000" class="mt-1 w-full form-input">
                                </div>
                                <div>
                                    <label for="waste" class="block text-sm font-medium">Waste Recycled (%)</label>
                                    <input type="number" id="waste" placeholder="e.g., 75" class="mt-1 w-full form-input">
                                </div>
                            </div>
                             <!-- Social -->
                             <div class="space-y-4 p-4 border rounded-lg border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold text-blue-700 dark:text-blue-400">Social</h3>
                                <div>
                                    <label for="diversity" class="block text-sm font-medium">Workforce Diversity (%)</label>
                                    <input type="number" id="diversity" placeholder="e.g., 45" class="mt-1 w-full form-input">
                                </div>
                                <div>
                                    <label for="safety" class="block text-sm font-medium">Safety Incidents</label>
                                    <input type="number" id="safety" placeholder="e.g., 2" class="mt-1 w-full form-input">
                                </div>
                            </div>
                        </div>
                        <!-- Governance -->
                        <div class="space-y-4 p-4 border rounded-lg border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold text-yellow-700 dark:text-yellow-400">Governance</h3>
                                <div>
                                    <label for="compliance" class="block text-sm font-medium">Compliance Training (%)</label>
                                    <input type="number" id="compliance" placeholder="e.g., 98" class="mt-1 w-full form-input">
                                </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            Submit Data
                        </button>
                    </form>
                </div>
            </section>

            <!-- Timesheet Section -->
            <section id="section-timesheet" class="section hidden">
                <header class="mb-6 flex flex-col md:flex-row justify-between md:items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Timesheet</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Track your work hours efficiently.</p>
                    </div>
                    <div id="clock-container" class="text-right mt-4 md:mt-0">
                         <div class="text-3xl font-bold" id="digital-clock">12:00:00 PM</div>
                         <div class="text-sm text-gray-500 dark:text-gray-400" id="current-date">Tuesday, Oct 7, 2025</div>
                    </div>
                </header>
                <!-- Clock In/Out Controls -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6 flex flex-col sm:flex-row justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold">Time Tracker</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Click to start or end your work session.</p>
                    </div>
                    <div class="mt-4 sm:mt-0">
                        <button id="clock-in-out-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 w-full sm:w-auto">
                            <i class="fas fa-play mr-2"></i>Clock In
                        </button>
                    </div>
                </div>
                <!-- Calendar and Summary -->
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div id="calendar-container" class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="month-year" class="text-lg font-semibold"></h3>
                            <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="calendar-header" class="grid grid-cols-7 gap-1 mb-2"></div>
                        <div id="calendar" class="grid grid-cols-7 gap-1"></div>
                    </div>
                    <div id="summary-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Summary for <span id="selected-date-str"></span></h3>
                        <div id="summary-content" class="text-sm text-gray-600 dark:text-gray-400">Select a date to see details.</div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="section hidden">
                <header class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Reports</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Generate and view your data reports.</p>
                </header>
                <div class="space-y-8">
                    <!-- Timesheet Report -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Timesheet Working Report</h3>
                             <button id="download-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                <i class="fas fa-download mr-2"></i>Download CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Date</th>
                                        <th scope="col" class="px-6 py-3">Clock In</th>
                                        <th scope="col" class="px-6 py-3">Clock Out</th>
                                        <th scope="col" class="px-6 py-3">Duration</th>
                                        <th scope="col" class="px-6 py-3">Note</th>
                                        <th scope="col" class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="report-table-body">
                                    <tr><td colspan="6" class="text-center p-6 text-gray-500">No records found.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ESG Report -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-bold">Generate ESG Report</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Select your criteria to generate a new report.</p>
                        <form id="report-generator-form" class="mt-6 no-print">
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <div>
                                     <label for="report-type" class="block text-sm font-medium">Report Type</label>
                                     <select id="report-type" class="mt-1 block w-full form-input">
                                         <option>Annual Summary</option>
                                         <option>Energy Consumption Analysis</option>
                                         <option>Waste Recycling Trends</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label for="start-date" class="block text-sm font-medium">Start Date</label>
                                     <input type="date" id="start-date" class="mt-1 block w-full form-input">
                                 </div>
                                 <div>
                                     <label for="end-date" class="block text-sm font-medium">End Date</label>
                                     <input type="date" id="end-date" class="mt-1 block w-full form-input">
                                 </div>
                             </div>
                             <div class="mt-6 flex justify-end">
                                 <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 flex items-center disabled:bg-blue-400">
                                     <span class="btn-text">Generate Report</span>
                                     <i class="fas fa-spinner fa-spin btn-loader hidden ml-2"></i>
                                 </button>
                             </div>
                         </form>
                        <div id="report-output" class="mt-8 hidden print-area">
                            <!-- Report content will be injected here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Manage your account and application preferences.</p>
                </header>
                <!-- <div class="flex flex-col md:flex-row gap-8"> -->
                <div class="settings-container">
                    <!-- Settings Navigation -->
                    <aside id="settings-sidebar" class="md:w-1/4 lg:w-1/5 sticky top-0 self-start">
                        <nav id="settings-nav" class="flex border-b border-gray-200">
                            <button data-settings-tab="profile" class="settings-link active w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md" data-tooltip="Profile">
                                <i class="fas fa-user w-5 h-5 mr-3"></i>
                                <span class="link-text">Profile</span>
                            </button>
                            <button data-settings-tab="security" class="settings-link w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md" data-tooltip="Security">
                                <i class="fas fa-shield-alt w-5 h-5 mr-3"></i>
                                <span class="link-text">Security</span>
                            </button>
                             <button data-settings-tab="team" class="settings-link w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md" data-tooltip="Team">
                                <i class="fas fa-users w-5 h-5 mr-3"></i>
                                <span class="link-text">Team</span>
                            </button>
                            <button data-settings-tab="notifications" class="settings-link w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md" data-tooltip="Notifications">
                                <i class="fas fa-bell w-5 h-5 mr-3"></i>
                                <span class="link-text">Notifications</span>
                            </button>
                            <button data-settings-tab="appearance" class="settings-link w-full flex items-center px-4 py-2.5 text-sm font-medium rounded-md" data-tooltip="Appearance">
                                <i class="fas fa-palette w-5 h-5 mr-3"></i>
                                <span class="link-text">Appearance</span>
                            </button>
                        </nav>
                    </aside>

                    <!-- Settings Content -->
                    <!-- <main class="flex-1"> -->
                    <main class="settings-content">
                        <!-- Profile Settings Tab -->
                        <div id="settings-tab-profile" class="settings-tab-content space-y-6">
                             <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-1">Public Profile</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">This information could be displayed publicly.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                                    <div>
                                        <label for="firstName" class="block text-sm font-medium">First Name</label>
                                        <input type="text" id="firstName" class="mt-1 block w-full form-input" placeholder="Harish">
                                    </div>
                                    <div>
                                        <label for="lastName" class="block text-sm font-medium">Last Name</label>
                                        <input type="text" id="lastName" class="mt-1 block w-full form-input" placeholder="V">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label for="bio" class="block text-sm font-medium">About</label>
                                    <textarea id="bio" rows="3" class="mt-1 block w-full form-input" placeholder="A brief description of yourself."></textarea>
                                </div>
                                <div class="text-right mt-6 border-t border-gray-200 dark:border-gray-700 pt-5">
                                    <button id="save-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-blue-400 disabled:cursor-not-allowed">
                                        <span class="btn-text">Save Changes</span>
                                        <i class="fas fa-spinner fa-spin btn-loader hidden"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Security Settings Tab -->
                        <div id="settings-tab-security" class="settings-tab-content hidden space-y-6">
                             <!-- UPGRADED: Change Password Section -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-1">Change Password</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Update your password. A strong password should contain a mix of letters, numbers, and symbols.</p>
                                <form id="change-password-form" class="space-y-4">
                                    <!-- Current Password -->
                                    <div>
                                        <label for="currentPassword" class="block text-sm font-medium">Current Password</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="currentPassword" class="form-input pr-10" required autocomplete="current-password">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 password-toggle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- New Password -->
                                    <div>
                                        <label for="newPassword" class="block text-sm font-medium">New Password</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="newPassword" class="form-input pr-10" required autocomplete="new-password">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 password-toggle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <!-- Password Strength Meter -->
                                        <div class="mt-2">
                                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                                <span>Password Strength</span>
                                                <span id="password-strength-text"></span>
                                            </div>
                                            <div class="mt-1 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300"></div>
                                            </div>
                                        </div>
                                        <ul id="password-criteria" class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                            <li data-criterion="length">At least 8 characters</li>
                                            <li data-criterion="lowercase">A lowercase letter</li>
                                            <li data-criterion="uppercase">An uppercase letter</li>
                                            <li data-criterion="number">A number</li>
                                            <li data-criterion="special">A special character (!@#$%^&*)</li>
                                        </ul>
                                    </div>
                                    <!-- Confirm New Password -->
                                    <div>
                                        <label for="confirmPassword" class="block text-sm font-medium">Confirm New Password</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="confirmPassword" class="form-input pr-10" required autocomplete="new-password">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 password-toggle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <p id="confirm-password-error" class="text-red-500 text-xs mt-1 hidden">Passwords do not match.</p>
                                    </div>
                                </form>
                                <div class="flex justify-between items-center mt-6 border-t border-gray-200 dark:border-gray-700 pt-5">
                                    <a href="#" id="forgot-password-link-settings" class="text-sm text-blue-600 hover:underline">Forgot password?</a>
                                    <button id="update-password-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-blue-400 disabled:cursor-not-allowed">
                                        <span class="btn-text">Update Password</span>
                                        <i class="fas fa-spinner fa-spin btn-loader hidden"></i>
                                    </button>
                                </div>
                            </div>
                             <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-300 p-6 rounded-md shadow-sm">
                                <h3 class="text-xl font-medium text-red-800 dark:text-red-200">Danger Zone</h3>
                                <p class="mt-2 text-sm">Permanently delete your data. This action cannot be undone.</p>
                                <div class="mt-4 space-y-3 sm:space-y-0 sm:space-x-3">
                                    <button data-delete-target="timesheet" class="danger-zone-btn w-full sm:w-auto bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded-lg border border-red-300">Clear Timesheet Data</button>
                                    <button data-delete-target="esg" class="danger-zone-btn w-full sm:w-auto bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded-lg border border-red-300">Clear ESG Data</button>
                                    <button data-delete-target="all" class="danger-zone-btn w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Clear All Data</button>
                                </div>
                            </div>
                        </div>

                        <!-- Team Settings Tab -->
                        <div id="settings-tab-team" class="settings-tab-content hidden space-y-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-1">Team Management</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Manage roles and invite new members.</p>
                                <ul id="team-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Team members will be injected here -->
                                </ul>
                            </div>
                             <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-4">Invite New Member</h3>
                                <form id="invite-form" class="space-y-4">
                                    <div>
                                        <label for="invite-email" class="block text-sm font-medium">Email Address</label>
                                        <input type="email" id="invite-email" class="mt-1 block w-full form-input" placeholder="new.member@example.com" required>
                                    </div>
                                    <div>
                                        <label for="invite-role" class="block text-sm font-medium">Role</label>
                                        <select id="invite-role" class="mt-1 block w-full form-input">
                                            <option>Contributor</option>
                                            <option>Viewer</option>
                                        </select>
                                    </div>
                                    <div class="text-right">
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Send Invite</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Notifications Settings Tab -->
                        <div id="settings-tab-notifications" class="settings-tab-content hidden space-y-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-1">Notifications</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Manage how you receive notifications.</p>
                                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <div class="toggle-container flex items-center justify-between py-3">
                                        <span class="font-medium">Weekly ESG Digest</span>
                                        <button class="toggle-switch bg-gray-200 dark:bg-gray-600" data-notification="weeklyDigest">
                                            <span class="toggle-knob"></span>
                                        </button>
                                    </div>
                                    <div class="toggle-container flex items-center justify-between py-3">
                                        <span class="font-medium">Regulatory Updates</span>
                                        <button class="toggle-switch bg-gray-200 dark:bg-gray-600" data-notification="regulatoryUpdates">
                                            <span class="toggle-knob"></span>
                                        </button>
                                    </div>
                                </div>
                                <!-- Save button is removed for auto-saving functionality -->
                            </div>
                        </div>

                        <!-- Appearance Settings Tab -->
                        <div id="settings-tab-appearance" class="settings-tab-content hidden space-y-6">
                             <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-semibold mb-1">Appearance</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Customize the look and feel of your interface.</p>
                                <div id="theme-selector" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     <button data-theme="light" class="theme-option p-6 rounded-lg border-2">
                                        <div class="flex items-center justify-center">
                                            <i class="fas fa-sun w-8 h-8"></i>
                                            <span class="ml-3 font-semibold">Light</span>
                                        </div>
                                    </button>
                                    <button data-theme="dark" class="theme-option p-6 rounded-lg border-2">
                                        <div class="flex items-center justify-center">
                                            <i class="fas fa-moon w-8 h-8"></i>
                                            <span class="ml-3 font-semibold">Dark</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </section>
        </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center modal-backdrop">
      <div class="p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30">
            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
          </div>
          <h3 id="modal-title" class="text-lg leading-6 font-medium mt-2">Are you sure?</h3>
          <p id="modal-message" class="text-sm text-gray-500 dark:text-gray-400 px-7 py-3">This action cannot be undone.</p>
          <div class="px-4 py-3 space-y-2">
            <div id="modal-input-container" class="space-y-2">
                <label for="confirmation-input" class="block text-sm font-medium text-left">To confirm, type <strong id="confirmation-text" class="select-none">DELETE</strong> below:</label>
                <input type="text" id="confirmation-input" class="mt-1 w-full form-input" autocomplete="off">
            </div>
            <button id="confirm-delete-btn" class="w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-700 disabled:bg-red-300 dark:disabled:bg-red-800 disabled:cursor-not-allowed">Confirm Action</button>
            <button id="cancel-delete-btn" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="ai-insights-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold flex items-center"><i class="fas fa-magic mr-3 text-purple-500"></i>AI-Powered Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">&times;</button>
            </div>
            <div id="ai-insights-content" class="text-sm text-gray-600 dark:text-gray-300 space-y-4 max-h-96 overflow-y-auto">
                <!-- AI content will be injected here -->
            </div>
        </div>
    </div>
    
     <div id="goal-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4" id="goal-modal-title">Set New Goal</h3>
            <form id="goal-form" class="space-y-4">
                 <input type="hidden" id="goal-id">
                 <div>
                    <label for="goal-metric" class="block text-sm font-medium">Metric</label>
                    <select id="goal-metric" class="mt-1 block w-full form-input" required>
                        <option value="energy">Energy Consumption (kWh)</option>
                        <option value="waste">Waste Recycled (%)</option>
                        <option value="diversity">Workforce Diversity (%)</option>
                        <option value="safety">Safety Incidents</option>
                        <option value="compliance">Compliance Training (%)</option>
                    </select>
                </div>
                 <div>
                    <label for="goal-target" class="block text-sm font-medium">Target Value</label>
                    <input type="number" id="goal-target" class="mt-1 block w-full form-input" required>
                </div>
                 <div>
                    <label for="goal-deadline" class="block text-sm font-medium">Deadline</label>
                    <input type="month" id="goal-deadline" class="mt-1 block w-full form-input" required>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-goal-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Goal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="document-upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Upload Document</h3>
            <form id="document-upload-form" class="space-y-4">
                 <div>
                    <label for="doc-name" class="block text-sm font-medium">Document Name</label>
                    <input type="text" id="doc-name" class="mt-1 block w-full form-input" required>
                </div>
                 <div>
                    <label for="doc-category" class="block text-sm font-medium">Category</label>
                     <select id="doc-category" class="mt-1 block w-full form-input" required>
                        <option>Annual Report</option>
                        <option>Certification</option>
                        <option>Policy</option>
                        <option>Other</option>
                    </select>
                </div>
                <div>
                    <label for="doc-file" class="block text-sm font-medium">File</label>
                    <input type="file" id="doc-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                     <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">Note: File upload is simulated. No data will be stored.</p>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-upload-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <div id="global-tooltip" class="tooltip" role="tooltip"></div>


    <!-- Add new CSS for toggles and theme options -->
    <style>
        .form-input {
             @apply block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500;
        }
        .toggle-switch {
            @apply relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800;
        }
        .toggle-knob {
            @apply pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0;
        }
        .toggle-switch.enabled {
            @apply bg-blue-600;
        }
        .toggle-switch.enabled .toggle-knob {
            @apply translate-x-5;
        }
        .theme-option {
            @apply border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 hover:border-gray-400 dark:hover:border-gray-500;
        }
        .theme-option.active {
            @apply border-blue-500 bg-blue-50 dark:bg-blue-900/30 ring-2 ring-blue-500;
        }
        .theme-option.active i, .theme-option.active span {
            @apply text-blue-600 dark:text-blue-400;
        }
    </style>

    

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, signOut, reauthenticateWithCredential, 
        EmailAuthProvider, updatePassword, linkWithCredential, signInAnonymously,
        signInWithCustomToken, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDocs, deleteDoc, query, collection, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- App Config & Firebase Init ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-esg-timesheet-app';
    
    // --- Firebase Configuration ---
    // IMPORTANT: This configuration is automatically provided in the execution environment.
    // The fallback is for local testing.
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config)
        : {
            apiKey: "AIzaSyDOFNeEl8rHsfTz-4TGBpYBAq2ukY1awJ0",
            authDomain: "manga-reader-30320.firebaseapp.com",
            projectId: "manga-reader-30320",
            storageBucket: "manga-reader-30320.appspot.com",
            messagingSenderId: "2604892274",
            appId: "1:2604892274:web:ccbb92a3e638f23a8442eb",
            measurementId: "G-PMJPMS181B"
          };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Global State ---
    let userId = null;
    let userSettings = { theme: 'light', notifications: { weeklyDigest: true, regulatoryUpdates: false }, profile: { firstName: '', lastName: '', bio: '' } };
    let timeLog = [];
    let esgRecords = [];
    let esgGoals = [];
    let teamMembers = [];
    let documents = [];
    let isClockedIn = false;
    let currentLogId = null;
    let calendarDate = new Date();
    let selectedDate = new Date();
    let charts = {};
    let currentDeletionTarget = null;
    let itemToDeleteId = null; 
    let unsubscribeListeners = [];
    
    // --- DOM Elements ---
    const loadingEl = document.getElementById('loading');
    const authContainer = document.getElementById('auth-container');
    const appContainerEl = document.getElementById('app-container');
    const userDisplayEl = document.getElementById('user-display');
    const navLinks = document.querySelectorAll('.nav-link');
    const toastContainer = document.getElementById('toast-container');
    
    // Modals
    const modal = document.getElementById('confirmation-modal');
    const modalTitle = document.getElementById('modal-title');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const modalInputContainer = document.getElementById('modal-input-container');
    const modalMessage = document.getElementById('modal-message');
    const confirmationInput = document.getElementById('confirmation-input');
    const confirmationText = document.getElementById('confirmation-text');

    // Auth Form elements
    const loginForm = document.getElementById('login-form');
    const authErrorEl = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const forgotPasswordLinkLogin = document.getElementById('forgot-password-link-login');
    
    // Timesheet Elements
    const clockInOutBtn = document.getElementById('clock-in-out-btn');
    const digitalClockEl = document.getElementById('digital-clock');
    const currentDateEl = document.getElementById('current-date');
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const summaryContentEl = document.getElementById('summary-content');
    const selectedDateStrEl = document.getElementById('selected-date-str');
    const reportTableBody = document.getElementById('report-table-body');
    const downloadCsvBtn = document.getElementById('download-csv-btn');

    // ESG Elements
    const esgForm = document.getElementById('esg-form');
    const chartToggles = document.getElementById('chart-toggles');
    const addFirstRecordBtn = document.getElementById('add-first-record-btn');

    // Reports Elements
    const reportGeneratorForm = document.getElementById('report-generator-form');
    const reportOutput = document.getElementById('report-output');

    // Goals Elements
    const addGoalBtn = document.getElementById('add-goal-btn');
    const goalModal = document.getElementById('goal-modal');
    const goalForm = document.getElementById('goal-form');
    const cancelGoalBtn = document.getElementById('cancel-goal-btn');
    const goalsContainer = document.getElementById('goals-container');

    // Documents Elements
    const uploadDocBtn = document.getElementById('upload-doc-btn');
    const docUploadModal = document.getElementById('document-upload-modal');
    const docUploadForm = document.getElementById('document-upload-form');
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    const documentsTableBody = document.getElementById('documents-table-body');

    // Settings Elements
    const settingsNav = document.getElementById('settings-nav');
    const settingsTabContents = document.querySelectorAll('.settings-tab-content');
    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const bioInput = document.getElementById('bio');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const notificationToggles = document.querySelectorAll('.toggle-switch');
    const dangerZoneButtons = document.querySelectorAll('.danger-zone-btn');
    const themeSelector = document.getElementById('theme-selector');
    const sidebarOpenBtn = document.getElementById('sidebar-open-btn');
    const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const teamList = document.querySelector('#team-list');
    const inviteForm = document.querySelector('#invite-form');

    // UPGRADED: Password Change Elements
    const changePasswordForm = document.getElementById('change-password-form');
    const updatePasswordBtn = document.getElementById('update-password-btn');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordStrengthBar = document.getElementById('password-strength-bar');
    const passwordStrengthText = document.getElementById('password-strength-text');
    const passwordCriteria = document.getElementById('password-criteria');
    const confirmPasswordError = document.getElementById('confirm-password-error');
    const forgotPasswordLinkSettings = document.getElementById('forgot-password-link-settings');
    const passwordToggles = document.querySelectorAll('.password-toggle');


    // AI Insights Elements
    const aiInsightsBtn = document.getElementById('ai-insights-btn');
    const aiInsightsModal = document.getElementById('ai-insights-modal');
    const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
    const aiInsightsContent = document.getElementById('ai-insights-content');


    // --- UI Helpers ---
    function showToast(message, type = 'success') {
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        const toast = document.createElement('div');
        toast.className = `toast text-white px-6 py-4 rounded-md shadow-lg flex items-center ${bgColor}`;
        toast.innerHTML = `<i class="fas ${icon} mr-3"></i> <p>${message}</p>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function setButtonLoading(button, isLoading) {
        if (!button) return;
        const text = button.querySelector('.btn-text');
        const loader = button.querySelector('.btn-loader');
        if (isLoading) {
            button.disabled = true;
            if(text) text.classList.add('hidden');
            if(loader) loader.classList.remove('hidden');
        } else {
            button.disabled = false;
            if(text) text.classList.remove('hidden');
            if(loader) loader.classList.add('hidden');
        }
    }

    function timeAgo(date) {
        if(!date) return '';
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
    }
    
    function setAuthError(message) {
        authErrorEl.textContent = message;
        authErrorEl.classList.toggle('hidden', !message);
    }

    function updateThemeButtons() {
        themeSelector.querySelectorAll('.theme-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.theme === userSettings.theme);
        });
    }

    // --- Core App Logic ---
    function showSection(sectionId) {
        document.querySelectorAll('main > div > section').forEach(section => {
            section.classList.toggle('hidden', section.id !== `section-${sectionId}`);
        });
        navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.section === sectionId);
        });
        if(sectionId === 'dashboard') {
            renderAllDashboardElements();
        }
        // Close sidebar on mobile nav
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }
    
    // --- Data Listeners ---
    function setupDataListeners() {
        if (!userId) return;
        
        // Clear any previous listeners
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];

        const collectionsToListen = {
            timeLogs: (data) => {
                timeLog = data;
                updateTimesheetUI();
            },
            esgData: (data) => {
                esgRecords = data.sort((a, b) => a.month.localeCompare(b.month));
                renderAllDashboardElements();
                renderRecentActivity();
            },
            esgGoals: (data) => {
                esgGoals = data;
                renderGoals();
                renderAllDashboardElements();
            },
            teamMembers: (data) => {
                teamMembers = data;
                renderTeamList();
            },
            documents: (data) => {
                documents = data;
                renderDocuments();
            }
        };

        for (const [coll, handler] of Object.entries(collectionsToListen)) {
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/${coll}`);
            const unsub = onSnapshot(collectionRef, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Convert Firestore Timestamps to JS Dates
                    ...(doc.data().uploadedAt?.toDate && { uploadedAt: doc.data().uploadedAt.toDate() }),
                    ...(doc.data().submittedAt?.toDate && { submittedAt: doc.data().submittedAt.toDate() })
                }));
                handler(data);
            });
            unsubscribeListeners.push(unsub);
        }
    }

    // --- Timesheet Feature ---
    function updateClock() {
        const now = new Date();
        digitalClockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        currentDateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('dashboard-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    }

    async function handleClockInOut() {
        if (!userId) return;
        const timeLogsCollection = collection(db, `artifacts/${appId}/users/${userId}/timeLogs`);
        const now = new Date();

        if (isClockedIn) {
            const logDocRef = doc(timeLogsCollection, currentLogId);
            await setDoc(logDocRef, { clockOut: now.getTime() }, { merge: true });
        } else {
            const newLogRef = await addDoc(timeLogsCollection, { clockIn: now.getTime(), clockOut: null, note: "" });
            currentLogId = newLogRef.id;
        }
    }

    function updateTimesheetUI() {
        const latestLog = timeLog.find(log => !log.clockOut);
        
        if (latestLog) {
            isClockedIn = true;
            currentLogId = latestLog.id;
            clockInOutBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Clock Out';
            clockInOutBtn.classList.replace('bg-blue-500', 'bg-red-500');
            clockInOutBtn.classList.replace('hover:bg-blue-600', 'hover:bg-red-600');
        } else {
            isClockedIn = false;
            currentLogId = null;
            clockInOutBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Clock In';
            clockInOutBtn.classList.replace('bg-red-500', 'bg-blue-500');
            clockInOutBtn.classList.replace('hover:bg-red-600', 'hover:bg-blue-600');
        }
        renderCalendar();
        updateSummary();
        renderReport();
    }

    function renderCalendar() {
        calendarEl.innerHTML = '';
        const calendarHeader = document.getElementById('calendar-header');
        calendarHeader.innerHTML = '';
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        monthYearEl.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        dayHeaders.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase pb-2';
            dayEl.textContent = day;
            calendarHeader.appendChild(dayEl);
        });
        
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        // Add previous month's trailing days
        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.textContent = daysInPrevMonth - firstDayOfMonth + i + 1;
            dayEl.className = 'text-center p-2 rounded-full h-9 w-9 text-sm text-gray-300 dark:text-gray-600';
            calendarEl.appendChild(dayEl);
        }

        // Add current month's days
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('button');
            dayEl.textContent = day;
            dayEl.className = 'text-center p-2 rounded-full h-9 w-9 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-blue-400 transition-colors duration-150';
            const dayDate = new Date(year, month, day);

            if (dayDate.toDateString() === new Date().toDateString()) {
                dayEl.classList.add('bg-blue-600', 'text-white', 'font-bold');
            } else if (dayDate.toDateString() === selectedDate.toDateString()) {
                dayEl.classList.add('bg-blue-200', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
            } else {
                dayEl.classList.add('hover:bg-gray-200', 'dark:hover:bg-gray-700');
            }
            
            if (timeLog.some(log => new Date(log.clockIn).toDateString() === dayDate.toDateString())) {
                 dayEl.classList.add('font-bold', 'relative');
                 let dot = document.createElement('span');
                 dot.className = 'absolute bottom-1.5 left-1/2 -translate-x-1/2 h-1.5 w-1.5 rounded-full bg-green-500';
                 dayEl.appendChild(dot);
            }

            dayEl.onclick = () => { selectedDate = dayDate; updateTimesheetUI(); };
            calendarEl.appendChild(dayEl);
        }

        // Add next month's leading days
        const totalCells = firstDayOfMonth + daysInMonth;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let i = 1; i <= remainingCells; i++) {
            const dayEl = document.createElement('div');
            dayEl.textContent = i;
            dayEl.className = 'text-center p-2 rounded-full h-9 w-9 text-sm text-gray-300 dark:text-gray-600';
            calendarEl.appendChild(dayEl);
        }
    }
    
    function changeMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderCalendar();
    }
    
    function updateSummary() {
        selectedDateStrEl.textContent = selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        const logsForDay = timeLog.filter(log => new Date(log.clockIn).toDateString() === selectedDate.toDateString());
        
        if (logsForDay.length === 0) {
            summaryContentEl.innerHTML = 'No work logged for this day.';
            return;
        }

        let totalMillis = 0;
        let summaryHTML = '<ul class="space-y-3">';
        logsForDay.forEach(log => {
            const clockInTime = new Date(log.clockIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let durationStr = 'In progress...';
            if (log.clockOut) {
                const clockOutTime = new Date(log.clockOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const duration = log.clockOut - log.clockIn;
                totalMillis += duration;
                durationStr = `${clockOutTime} (${formatDuration(duration)})`;
            }
            summaryHTML += `<li class="flex justify-between items-center"><span><i class="fas fa-sign-in-alt text-green-500 mr-2"></i>${clockInTime}</span><span><i class="fas fa-sign-out-alt text-red-500 mr-2"></i>${durationStr}</span></li>`;
        });
        summaryHTML += '</ul>';

        if(totalMillis > 0) {
             summaryHTML += `<div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 font-semibold text-base">Total: ${formatDuration(totalMillis)}</div>`;
        }
        summaryContentEl.innerHTML = summaryHTML;
    }

    function formatDuration(ms) {
        if (ms < 0) ms = 0;
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        return `${h}h ${m}m`;
    }

    function renderReport() {
        reportTableBody.innerHTML = '';
        const sortedLogs = [...timeLog].sort((a, b) => b.clockIn - a.clockIn);

        if (sortedLogs.length === 0) {
            reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-6 text-gray-500">No records found.</td></tr>';
            return;
        }
        sortedLogs.forEach(log => {
            const clockInDate = new Date(log.clockIn);
            let duration = 'In progress';
            let clockOutTimeStr = '-';
            
            if(log.clockOut) {
                duration = formatDuration(log.clockOut - log.clockIn);
                clockOutTimeStr = new Date(log.clockOut).toLocaleTimeString();
            }

            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
            
            const noteCell = log.clockOut ? `
                <div class="note-display flex items-center justify-between">
                    <span class="note-text">${log.note || ''}</span>
                    <button class="edit-note-btn text-blue-500 hover:text-blue-700 ml-2" data-id="${log.id}">
                        <i class="fas ${log.note ? 'fa-pencil-alt' : 'fa-plus'}"></i>
                    </button>
                </div>
            ` : '';

            row.innerHTML = `
                <td class="px-6 py-4">${clockInDate.toLocaleDateString()}</td>
                <td class="px-6 py-4">${clockInDate.toLocaleTimeString()}</td>
                <td class="px-6 py-4">${clockOutTimeStr}</td>
                <td class="px-6 py-4">${duration}</td>
                <td class="px-6 py-4 note-cell">${noteCell}</td>
                <td class="px-6 py-4">
                    <button class="delete-log-btn text-red-500 hover:text-red-700" data-id="${log.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            reportTableBody.appendChild(row);
        });
    }

    function downloadCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Date,Clock In,Clock Out,Duration (HH:MM),Note\n";
        timeLog.forEach(log => {
            const clockIn = new Date(log.clockIn);
            let clockOutTime = '', duration = '';
            if (log.clockOut) {
                clockOutTime = new Date(log.clockOut).toLocaleTimeString();
                const diffMs = log.clockOut - log.clockIn;
                duration = `${String(Math.floor(diffMs / 3600000)).padStart(2, '0')}:${String(Math.floor((diffMs % 3600000) / 60000)).padStart(2, '0')}`;
            }
            const row = [clockIn.toLocaleDateString(), clockIn.toLocaleTimeString(), clockOutTime, duration, `"${log.note || ''}"`].join(",");
            csvContent += row + "\r\n";
        });

        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `timesheet_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
    }

    // --- ESG Feature ---
    async function handleEsgFormSubmit(e) {
        e.preventDefault();
        if(!userId) return;
        const button = e.target.querySelector('button[type="submit"]');
        setButtonLoading(button, true);

        const esgCollection = collection(db, `artifacts/${appId}/users/${userId}/esgData`);
        const formData = {
            month: document.getElementById('month').value,
            energy: parseFloat(document.getElementById('energy').value) || 0,
            waste: parseFloat(document.getElementById('waste').value) || 0,
            diversity: parseFloat(document.getElementById('diversity').value) || 0,
            safety: parseFloat(document.getElementById('safety').value) || 0,
            compliance: parseFloat(document.getElementById('compliance').value) || 0,
            submittedAt: serverTimestamp(),
        };
        try {
            await addDoc(esgCollection, formData);
            esgForm.reset();
            showToast('ESG data submitted successfully!');
            showSection('dashboard');
        } catch (error) {
            console.error("Error submitting ESG data:", error);
            showToast('Failed to submit data.', 'error');
        } finally {
             setButtonLoading(button, false);
        }
    }
    
    function renderRecentActivity() {
        const feedEl = document.getElementById('recent-activity-feed');
        feedEl.innerHTML = ''; // Clear existing content

        if (esgRecords.length === 0) {
            feedEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-3">No recent activity.</p>`;
            return;
        }

        const recentActivities = [...esgRecords]
            .filter(r => r.submittedAt)
            .sort((a, b) => b.submittedAt - a.submittedAt)
            .slice(0, 3);

        if (recentActivities.length === 0) {
             feedEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-3">No recent submissions found.</p>`;
             return;
        }

        recentActivities.forEach(record => {
            const activityDate = record.submittedAt;
            const activityEl = document.createElement('div');
            activityEl.className = 'flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';
            activityEl.innerHTML = `
                <i class="fas fa-check-circle text-green-500 mr-4"></i>
                <div>
                    <p>New <strong>ESG Data</strong> submitted for <strong>${new Date(record.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}</strong>.</p>
                     <p class="text-xs text-gray-500 dark:text-gray-400">${timeAgo(activityDate)}</p>
                </div>
            `;
            feedEl.appendChild(activityEl);
        });
    }

    // --- Reports Feature ---
    function handleEsgReportGeneration(e) {
        e.preventDefault();
        const reportBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(reportBtn, true);

        const reportType = document.getElementById('report-type').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
            showToast("Please select a start and end date.", "error");
            setButtonLoading(reportBtn, false);
            return;
        }
        
        // Filter esgRecords based on the selected date range
        const startMonth = startDate.substring(0, 7);
        const endMonth = endDate.substring(0, 7);
        const filteredData = esgRecords.filter(record => record.month >= startMonth && record.month <= endMonth);

        if (filteredData.length === 0) {
            reportOutput.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-400 py-8">No data found for the selected period.</p>`;
        } else {
            const reportHTML = generateEsgReportHTML(reportType, filteredData, startDate, endDate);
            reportOutput.innerHTML = reportHTML;
        }
        reportOutput.classList.remove('hidden');
        setButtonLoading(reportBtn, false);
    }

    function generateEsgReportHTML(reportType, data, startDate, endDate) {
        let title = `${reportType} Report`;
        let summaryHTML = '';
        let tableHeaders = [];
        let tableRows = [];

        if (reportType === 'Energy Consumption Analysis') {
            title = 'Energy Consumption Analysis';
            tableHeaders = ['Month', 'Energy Consumption (kWh)'];
            tableRows = data.map(d => `
                <tr class="border-b dark:border-gray-700">
                    <td class="p-3">${d.month}</td><td class="p-3">${d.energy.toLocaleString()}</td>
                </tr>`);
            const totalValue = data.reduce((acc, item) => acc + item.energy, 0);
            summaryHTML = `<div class="grid grid-cols-2 gap-4 mb-6 text-center"><div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"><p class="text-sm text-gray-500 dark:text-gray-400">Total Records</p><p class="text-2xl font-bold">${data.length}</p></div><div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"><p class="text-sm text-gray-500 dark:text-gray-400">Total Consumption</p><p class="text-2xl font-bold">${totalValue.toLocaleString()} kWh</p></div></div>`;
        } else if (reportType === 'Waste Recycling Trends') {
            title = 'Waste Recycling Trends';
            tableHeaders = ['Month', 'Waste Recycled (%)'];
            tableRows = data.map(d => `
                <tr class="border-b dark:border-gray-700">
                    <td class="p-3">${d.month}</td><td class="p-3">${d.waste}%</td>
                </tr>`);
            const avgValue = data.length > 0 ? data.reduce((acc, item) => acc + item.waste, 0) / data.length : 0;
            summaryHTML = `<div class="grid grid-cols-2 gap-4 mb-6 text-center"><div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"><p class="text-sm text-gray-500 dark:text-gray-400">Total Records</p><p class="text-2xl font-bold">${data.length}</p></div><div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"><p class="text-sm text-gray-500 dark:text-gray-400">Average Rate</p><p class="text-2xl font-bold">${avgValue.toFixed(2)}%</p></div></div>`;
        } else { // Annual Summary
            title = 'Annual ESG Summary';
            tableHeaders = ['Month', 'Energy (kWh)', 'Waste (%)', 'Diversity (%)', 'Safety Inc.', 'Compliance (%)'];
            tableRows = data.map(d => `
                <tr class="border-b dark:border-gray-700">
                    <td class="p-3">${d.month}</td><td class="p-3">${d.energy.toLocaleString()}</td><td class="p-3">${d.waste}</td><td class="p-3">${d.diversity}</td><td class="p-3">${d.safety}</td><td class="p-3">${d.compliance}</td>
                </tr>`);
            summaryHTML = `<div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"><p class="text-lg text-center">Found ${data.length} monthly records for the selected period.</p></div>`;
        }

        const tableHTML = `<table class="w-full text-left"><thead><tr class="bg-gray-100 dark:bg-gray-700 border-b dark:border-gray-600"><th class="p-4">${tableHeaders.join('</th><th class="p-4">')}</th></tr></thead><tbody>${tableRows.join('')}</tbody></table>`;
        return `<div class="no-print mb-4 flex justify-between items-center"><h3 class="text-xl font-semibold">${title}</h3><button onclick="window.print()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 text-sm">Print</button></div><p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Period: ${startDate} to ${endDate}</p>${summaryHTML}${tableHTML}`;
    }

    function setDefaultReportDates() {
        document.getElementById('end-date').valueAsDate = new Date();
        let lastYear = new Date();
        lastYear.setFullYear(lastYear.getFullYear() - 1);
        document.getElementById('start-date').valueAsDate = lastYear;
    }

    // --- Dashboard Charting & Data Calculation ---
    function calculateEsgScore(record) {
        if (!record) return 0;
        const envScore = calculateEnvironmentalScore(record);
        const socScore = calculateSocialScore(record);
        const govScore = calculateGovernanceScore(record);
        return (envScore + socScore + govScore) / 3;
    }

     function calculateEnvironmentalScore(record) {
        if(!record || record.waste === undefined || record.energy === undefined) return 0;
        const energyScore = 100 - Math.min(100, (record.energy / 10000) * 100);
        return (energyScore + record.waste) / 2;
    }

    function calculateSocialScore(record) {
        if(!record || record.diversity === undefined || record.safety === undefined) return 0;
        const safetyScore = 100 - (record.safety * 20); // 5 incidents = 0 score
        return (record.diversity + safetyScore) / 2;
    }

    function calculateGovernanceScore(record) {
        if(!record || record.compliance === undefined) return 0;
        return record.compliance;
    }


    function updateTrendElement(containerId, currentValue, previousValue, lowerIsBetter = false) {
        const container = document.getElementById(containerId);
        const textEl = container.querySelector('span');
        const icon = container.querySelector('i');

        if (!isFinite(previousValue) || previousValue === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'flex';

        const change = ((currentValue - previousValue) / previousValue) * 100;

        if (Math.abs(change) < 0.1) {
            container.className = 'flex items-center text-sm text-gray-500 dark:text-gray-400';
            icon.className = 'fas fa-minus mr-1';
            textEl.textContent = 'No change';
            return;
        }

        const isIncrease = change > 0;
        const isGood = lowerIsBetter ? !isIncrease : isIncrease;
        
        container.className = `flex items-center text-sm ${isGood ? 'text-green-500' : 'text-red-500'}`;
        icon.className = `fas ${isIncrease ? 'fa-arrow-up' : 'fa-arrow-down'} mr-1`;
        textEl.textContent = `${isIncrease ? '+' : ''}${change.toFixed(1)}% vs last quarter`;
    }

    function renderAllDashboardElements() {
        const noDataEl = document.getElementById('dashboard-no-data');
        const mainContentEl = document.getElementById('dashboard-main-content');

        if (esgRecords.length === 0) {
            noDataEl.classList.remove('hidden');
            mainContentEl.classList.add('hidden');
            return;
        }

        noDataEl.classList.add('hidden');
        mainContentEl.classList.remove('hidden');

        const isDark = userSettings.theme === 'dark';
        const textColor = isDark ? '#e5e7eb' : '#374151';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

        const labels = esgRecords.map(r => new Date(r.month + '-02').toLocaleString('default', { month: 'short' }));
        const latestRecord = esgRecords[esgRecords.length - 1];

        // --- Trend Calculation ---
        const latestDate = new Date(latestRecord.month + '-02');
        const prevQuarterDate = new Date(latestDate);
        prevQuarterDate.setMonth(prevQuarterDate.getMonth() - 3);
        const prevQuarterYear = prevQuarterDate.getFullYear();
        const prevQuarterNumber = Math.floor(prevQuarterDate.getMonth() / 3); // 0-3 for Q1-Q4

        const prevQuarterRecords = esgRecords.filter(r => {
            const d = new Date(r.month + '-02');
            return d.getFullYear() === prevQuarterYear && Math.floor(d.getMonth() / 3) === prevQuarterNumber;
        });

        if (prevQuarterRecords.length > 0) {
            const avgReducer = (key) => (acc, r) => acc + r[key];
            const avgPrevEnergy = prevQuarterRecords.reduce(avgReducer('energy'), 0) / prevQuarterRecords.length;
            const avgPrevWaste = prevQuarterRecords.reduce(avgReducer('waste'), 0) / prevQuarterRecords.length;
            const avgPrevCompliance = prevQuarterRecords.reduce(avgReducer('compliance'), 0) / prevQuarterRecords.length;
            
            const avgPrevRecord = {
                energy: avgPrevEnergy,
                waste: avgPrevWaste,
                diversity: prevQuarterRecords.reduce(avgReducer('diversity'), 0) / prevQuarterRecords.length,
                safety: prevQuarterRecords.reduce(avgReducer('safety'), 0) / prevQuarterRecords.length,
                compliance: avgPrevCompliance,
            };

            const prevEsgScore = calculateEsgScore(avgPrevRecord);
            const currentEsgScore = calculateEsgScore(latestRecord);

            updateTrendElement('kpi-esg-trend-container', currentEsgScore, prevEsgScore);
            updateTrendElement('kpi-energy-trend-container', latestRecord.energy, avgPrevEnergy, true);
            updateTrendElement('kpi-waste-trend-container', latestRecord.waste, avgPrevWaste);
            updateTrendElement('kpi-social-trend-container', latestRecord.compliance, avgPrevCompliance);

        } else {
            ['kpi-esg-trend-container', 'kpi-energy-trend-container', 'kpi-waste-trend-container', 'kpi-social-trend-container'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
            });
        }

        const overallScore = Math.round(calculateEsgScore(latestRecord)) || 0;
        document.getElementById('kpi-esg-score').textContent = overallScore;
        document.getElementById('kpi-esg-text').textContent = `${overallScore}%`;
        document.getElementById('kpi-energy').innerHTML = `${(latestRecord.energy || 0).toLocaleString()} <span class="text-base font-normal text-gray-500">kWh</span>`;
        document.getElementById('kpi-waste').textContent = `${latestRecord.waste || 0}%`;
        document.getElementById('kpi-waste-text').textContent = `${latestRecord.waste || 0}%`;
        document.getElementById('kpi-social').textContent = `${latestRecord.compliance || 0}%`;
        document.getElementById('kpi-social-text').textContent = `${latestRecord.compliance || 0}%`;
        
        const energyTargetProgress = 100 - ((latestRecord.energy || 0) / 10000 * 100);
        document.getElementById('kpi-energy-text').textContent = `${Math.round(energyTargetProgress)}%`;

        const mainChartOptions = {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { color: gridColor } } },
            plugins: { legend: { labels: { color: textColor } } }
        };

        const activeToggle = chartToggles.querySelector('.active').dataset.chart;
        updateMainChart(activeToggle, labels, mainChartOptions);

        renderDoughnutChart('kpi-esg-chart', overallScore, '#3b82f6');
        renderDoughnutChart('kpi-energy-chart', energyTargetProgress, '#10b981'); // Target is < 10000
        renderDoughnutChart('kpi-waste-chart', latestRecord.waste || 0, '#f59e0b');
        renderDoughnutChart('kpi-social-chart', latestRecord.compliance || 0, '#8b5cf6');
        renderMetricBreakdownChart();
        renderInsightsAndAlerts();
        renderGoalProgress();
        renderBenchmarkChart();
    }
    
    function updateMainChart(type, labels, options) {
        let datasets = [];
        if (type === 'environmental') {
            datasets = [
                { label: 'Energy (kWh)', data: esgRecords.map(r => r.energy), borderColor: '#16a34a', tension: 0.3, fill: false },
                { label: 'Waste Recycled (%)', data: esgRecords.map(r => r.waste), borderColor: '#65a30d', tension: 0.3, fill: false },
            ];
        } else if (type === 'social') {
            datasets = [
                { label: 'Workforce Diversity (%)', data: esgRecords.map(r => r.diversity), borderColor: '#2563eb', tension: 0.3, fill: false },
                { label: 'Safety Incidents', data: esgRecords.map(r => r.safety), borderColor: '#60a5fa', tension: 0.3, fill: false },
            ];
        } else { // governance
             datasets = [
                { label: 'Compliance Training (%)', data: esgRecords.map(r => r.compliance), borderColor: '#d97706', tension: 0.3, fill: false },
            ];
        }
        renderLineChart('main-dashboard-chart', labels, datasets, options);
    }
    
    function renderMetricBreakdownChart() {
        const latestRecord = esgRecords[esgRecords.length - 1] || {};
        const isDark = userSettings.theme === 'dark';
        const textColor = isDark ? '#e5e7eb' : '#374151';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        const energyScore = 100 - Math.min(100, (latestRecord.energy / 10000) * 100); // Target is < 10000
        const wasteScore = latestRecord.waste || 0;
        const diversityScore = latestRecord.diversity || 0;
        const safetyScore = 100 - ((latestRecord.safety || 0) * 20); // 5 incidents = 0 score
        const complianceScore = latestRecord.compliance || 0;

        const data = {
            labels: ['Energy', 'Waste', 'Diversity', 'Safety', 'Compliance'],
            datasets: [{
                label: 'Metric Score (out of 100)',
                data: [energyScore, wasteScore, diversityScore, safetyScore, complianceScore],
                backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6'],
            }]
        };

        const options = {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { ticks: { color: textColor }, grid: { color: gridColor }, min: 0, max: 100 }, y: { ticks: { color: textColor }, grid: { color: gridColor } } },
            plugins: { legend: { display: false } }
        };

        renderBarChart('metric-breakdown-chart', data, options);
    }
    
    function renderInsightsAndAlerts() {
        const container = document.getElementById('insights-alerts-container');
        container.innerHTML = '';
        const latestRecord = esgRecords[esgRecords.length - 1] || {};

        const alerts = [];
        // Alert 1: Energy consumption
        if (latestRecord.energy > 8000) {
            alerts.push({ type: 'warning', icon: 'fa-bolt', text: `High energy use this month (${latestRecord.energy.toLocaleString()} kWh). Review efficiency measures.` });
        }
        // Alert 2: Safety incidents
        if (latestRecord.safety > 0) {
            alerts.push({ type: 'danger', icon: 'fa-exclamation-triangle', text: `${latestRecord.safety} safety incident(s) reported. Immediate review required.` });
        } else {
             alerts.push({ type: 'success', icon: 'fa-shield-alt', text: `Excellent record: 0 safety incidents reported this month.` });
        }
        // Alert 3: Compliance goal
        if (latestRecord.compliance < 95) {
             alerts.push({ type: 'info', icon: 'fa-info-circle', text: `Compliance training at ${latestRecord.compliance}%. Push for 100% completion.` });
        }
        
        if (alerts.length === 0) {
            container.innerHTML = `<div class="md:col-span-3 text-center p-4 text-gray-500">No new insights or alerts.</div>`;
            return;
        }

        alerts.forEach(alert => {
            const colors = {
                warning: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border-yellow-400',
                danger: 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border-red-400',
                success: 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border-green-400',
                info: 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 border-blue-400'
            };
            const alertEl = document.createElement('div');
            alertEl.className = `flex items-start p-4 rounded-lg border-l-4 ${colors[alert.type]}`;
            alertEl.innerHTML = `<i class="fas ${alert.icon} mt-1 mr-3"></i><p class="text-sm">${alert.text}</p>`;
            container.appendChild(alertEl);
        });
    }

    function renderNewsFeed() {
        const newsFeed = document.getElementById('esg-news-feed');
        const newsItems = [
            { text: "New EU Directive on Corporate Sustainability Due Diligence finalized.", link: "#" },
            { text: "Global carbon tax framework proposed at UN Summit.", link: "#" },
            { text: "Report: Companies with high ESG scores show greater financial resilience.", link: "#" },
        ];
        newsFeed.innerHTML = newsItems.map(item => `
            <li class="border-b border-gray-200 dark:border-gray-700 pb-2">
                <a href="${item.link}" class="hover:text-blue-500 transition-colors">${item.text} <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
            </li>
        `).join('');
    }

    function renderBarChart(canvasId, data, options) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: options,
        });
    }


    function renderLineChart(canvasId, labels, datasets, options) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: options
        });
    }

    function renderDoughnutChart(canvasId, score, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        const scoreValue = Math.max(0, Math.min(100, score || 0));
        charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{ 
                    data: [scoreValue, 100 - scoreValue], 
                    backgroundColor: [color, userSettings.theme === 'dark' ? '#374151' : '#e5e7eb'], 
                    borderWidth: 0,
                    borderRadius: 5,
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { tooltip: { enabled: false } } }
        });
    }

    function renderBenchmarkChart() {
        const latestRecord = esgRecords[esgRecords.length - 1] || {};
        const isDark = userSettings.theme === 'dark';
        const textColor = isDark ? '#e5e7eb' : '#374151';
        
        const envScore = calculateEnvironmentalScore(latestRecord);
        const socScore = calculateSocialScore(latestRecord);
        const govScore = calculateGovernanceScore(latestRecord);

        const data = {
            labels: ['Environmental', 'Social', 'Governance'],
            datasets: [
                {
                    label: 'Your Score',
                    data: [envScore, socScore, govScore],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                },
                {
                    label: 'Industry Average',
                    data: [75, 80, 85], // Simulated data
                    backgroundColor: 'rgba(236, 72, 153, 0.2)',
                    borderColor: 'rgba(236, 72, 153, 1)',
                    borderWidth: 2,
                }
            ]
        };
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                    grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                    pointLabels: { color: textColor },
                    ticks: {
                        backdropColor: 'transparent',
                        color: textColor
                    },
                    min: 0,
                    max: 100
                }
            },
            plugins: {
                legend: { labels: { color: textColor } }
            }
        };

        const ctx = document.getElementById('benchmark-chart').getContext('2d');
        if (charts['benchmark-chart']) charts['benchmark-chart'].destroy();
        charts['benchmark-chart'] = new Chart(ctx, {
            type: 'radar',
            data,
            options
        });
    }
    
    // --- Settings Feature ---
    async function loadUserSettings() {
        if (!userId) return;
        const settingsRef = doc(db, `/artifacts/${appId}/users/${userId}/settings/user_settings`);
        const docSnap = await getDoc(settingsRef);

        if (docSnap.exists()) {
            const loadedSettings = docSnap.data();
            userSettings = {
                ...userSettings,
                ...loadedSettings,
                notifications: { ...userSettings.notifications, ...loadedSettings.notifications },
                profile: { ...userSettings.profile, ...loadedSettings.profile },
            };
        }
        applySettings();
    }

    function applySettings() {
        document.documentElement.className = userSettings.theme;
        updateThemeButtons();

        const displayName = `${userSettings.profile.firstName || ''} ${userSettings.profile.lastName || ''}`.trim();
        const user = auth.currentUser;
        if (user) {
            userDisplayEl.textContent = displayName || user.email || (user.isAnonymous ? 'Anonymous User' : 'User');
        }

        firstNameInput.value = userSettings.profile.firstName || '';
        lastNameInput.value = userSettings.profile.lastName || '';
        bioInput.value = userSettings.profile.bio || '';
        
        notificationToggles.forEach(toggle => {
            const key = toggle.dataset.notification;
            const isEnabled = userSettings.notifications[key] || false;
            toggle.classList.toggle('enabled', isEnabled);
        });
        
        renderAllDashboardElements(); 
    }
    
    async function saveUserSettings() {
        if (!userId) return;
        const settingsRef = doc(db, `/artifacts/${appId}/users/${userId}/settings/user_settings`);
        await setDoc(settingsRef, userSettings, { merge: true });
    }
    
    async function deleteCollection(collPath) {
        const q = query(collection(db, collPath));
        const snapshot = await getDocs(q);
        const promises = [];
        snapshot.forEach(doc => promises.push(deleteDoc(doc.ref)));
        await Promise.all(promises);
    };

    // --- Goals Feature ---
    function renderGoals() {
        goalsContainer.innerHTML = '';
        if(esgGoals.length === 0) {
            goalsContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">You haven't set any goals yet. Click "New Goal" to get started.</p>`;
            return;
        }

        const latestRecord = esgRecords[esgRecords.length - 1] || {};

        esgGoals.forEach(goal => {
            const currentValue = latestRecord[goal.metric] || 0;
            const targetValue = parseFloat(goal.target);
            let progress = 0;
            const lowerIsBetter = ['energy', 'safety'].includes(goal.metric);
            
            if (lowerIsBetter) {
                 progress = currentValue <= targetValue ? 100 : (targetValue / currentValue) * 100;
            } else {
                 progress = (currentValue / targetValue) * 100;
            }
            progress = Math.min(100, Math.max(0, progress));

            const goalCard = document.createElement('div');
            goalCard.className = 'bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md';
            goalCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${goal.metric.charAt(0).toUpperCase() + goal.metric.slice(1)}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Target: ${targetValue} by ${goal.deadline}</p>
                    </div>
                    <button class="delete-goal-btn text-red-500 hover:text-red-700" data-id="${goal.id}"><i class="fas fa-trash"></i></button>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-sm">Current: ${currentValue}</p>
                        <p class="text-sm font-bold text-blue-500">${Math.round(progress)}%</p>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%;"></div>
                    </div>
                </div>
            `;
            goalsContainer.appendChild(goalCard);
        });
    }
    
    function renderGoalProgress() {
        const container = document.getElementById('goal-progress-container');
        container.innerHTML = '';
        if(esgGoals.length === 0 || esgRecords.length === 0) {
            container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No active goals to track.</p>`;
            return;
        }
        
        const latestRecord = esgRecords[esgRecords.length - 1];
        
        esgGoals.slice(0, 3).forEach(goal => { // Show top 3 on dashboard
             const currentValue = latestRecord[goal.metric] || 0;
            const targetValue = parseFloat(goal.target);
            let progress = 0;
            const lowerIsBetter = ['energy', 'safety'].includes(goal.metric);
            
            if (lowerIsBetter) {
                 progress = currentValue <= targetValue ? 100 : (targetValue / currentValue) * 100;
            } else {
                 progress = (currentValue / targetValue) * 100;
            }
            progress = Math.min(100, Math.max(0, progress));

            const goalEl = document.createElement('li');
            goalEl.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <p class="font-medium text-sm">${goal.metric.charAt(0).toUpperCase() + goal.metric.slice(1)}</p>
                    <p class="text-sm font-bold text-blue-500">${Math.round(progress)}%</p>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${progress}%;"></div>
                </div>
            `;
            container.appendChild(goalEl);
        });
    }

    // --- Documents Feature ---
    function renderDocuments() {
        documentsTableBody.innerHTML = '';
        if (documents.length === 0) {
            documentsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500 dark:text-gray-400">No documents uploaded yet.</td></tr>`;
            return;
        }

        const sortedDocs = [...documents].sort((a, b) => b.uploadedAt - a.uploadedAt);

        sortedDocs.forEach(doc => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `
                <td class="px-6 py-4 font-medium">${doc.name}</td>
                <td class="px-6 py-4">${doc.category}</td>
                <td class="px-6 py-4">${doc.uploadedAt.toLocaleDateString()}</td>
                <td class="px-6 py-4 flex space-x-4">
                    <button class="text-blue-500 hover:text-blue-700" title="Download (Simulated)"><i class="fas fa-download"></i></button>
                    <button class="delete-doc-btn text-red-500 hover:text-red-700" data-id="${doc.id}" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            `;
            documentsTableBody.appendChild(row);
        });
    }

    // --- AI Insights Feature ---
    async function getAiInsights() {
        if(esgRecords.length === 0) {
            return showToast("Please add some ESG data before requesting insights.", "error");
        }
        
        aiInsightsModal.classList.remove('hidden');
        aiInsightsContent.innerHTML = `<div class="flex items-center justify-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-purple-500"></i><p class="ml-4">Generating insights...</p></div>`;

        const latestData = esgRecords[esgRecords.length - 1];
        const systemPrompt = "You are an expert ESG consultant. Analyze the following monthly data and provide a brief, actionable, bulleted list of recommendations for improvement. Format the response as simple HTML list items (<li>).";
        const userQuery = `My latest ESG data: Energy Consumption is ${latestData.energy} kWh, Waste Recycled is ${latestData.waste}%, Workforce Diversity is ${latestData.diversity}%, Safety Incidents is ${latestData.safety}, and Compliance Training is ${latestData.compliance}%. What are your top recommendations?`;
        
        const apiKey = "AIzaSyA-FfPzdQSAoWF40GaGQyhhU4X9QKDraKU"; // This will be handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(!response.ok) throw new Error(`API Error: ${response.statusText}`);
            
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                aiInsightsContent.innerHTML = `<ul class="list-disc list-inside space-y-2">${text}</ul>`;
            } else {
                throw new Error("No content received from AI.");
            }
        } catch(error) {
            console.error("AI Insights Error:", error);
            aiInsightsContent.innerHTML = `<p class="text-red-500">Could not generate insights at this time. Please try again later.</p>`;
        }
    }

     // --- Team Management Feature ---
    function renderTeamList() {
        teamList.innerHTML = '';
        const currentUser = auth.currentUser;

        if (!currentUser) return;

        // Add the current user (Admin)
        const adminLi = document.createElement('li');
        adminLi.className = 'py-3 flex justify-between items-center';
        adminLi.innerHTML = `
            <div>
                <p class="font-medium">You (${userSettings.profile.firstName || 'Admin'})</p>
                <p class="text-sm text-gray-500">${currentUser.email || 'Anonymous'}</p>
            </div>
            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Admin</span>
        `;
        teamList.appendChild(adminLi);
        
        // Add other team members
        teamMembers.forEach(member => {
            const memberLi = document.createElement('li');
            memberLi.className = 'py-3 flex justify-between items-center';
            memberLi.innerHTML = `
                <div>
                    <p class="font-medium">${member.email}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">${member.role}</span>
                    <button class="remove-member-btn text-red-500 hover:text-red-700" data-id="${member.id}"><i class="fas fa-times"></i></button>
                </div>
            `;
            teamList.appendChild(memberLi);
        });
    }

    // --- Deletion & Confirmation Modal Logic ---
    function openConfirmationModal(target, id, message, title = 'Are you sure?', confirmText = 'DELETE') {
        currentDeletionTarget = target;
        itemToDeleteId = id;
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        confirmationText.textContent = confirmText;
        
        if (confirmText) {
            modalInputContainer.style.display = 'block';
            confirmationInput.value = '';
            confirmDeleteBtn.disabled = true;
        } else {
            modalInputContainer.style.display = 'none';
            confirmDeleteBtn.disabled = false;
        }
        modal.classList.remove('hidden');
    }

    async function handleConfirmDeletion() {
        setButtonLoading(confirmDeleteBtn, true);
        try {
            const collectionMap = {
                singleLog: 'timeLogs',
                goal: 'esgGoals',
                teamMember: 'teamMembers',
                document: 'documents'
            };

            if (collectionMap[currentDeletionTarget]) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionMap[currentDeletionTarget]}`, itemToDeleteId);
                await deleteDoc(docRef);
                showToast(`${currentDeletionTarget.replace(/([A-Z])/g, ' $1').toLowerCase()} deleted.`);
            } else if (currentDeletionTarget === 'timesheet') {
                await deleteCollection(`artifacts/${appId}/users/${userId}/timeLogs`);
                showToast('Timesheet data has been cleared.');
            } else if (currentDeletionTarget === 'esg') {
                await deleteCollection(`artifacts/${appId}/users/${userId}/esgData`);
                await deleteCollection(`artifacts/${appId}/users/${userId}/esgGoals`);
                showToast('ESG data has been cleared.');
            } else if (currentDeletionTarget === 'all') {
                await Promise.all([
                    deleteCollection(`artifacts/${appId}/users/${userId}/timeLogs`),
                    deleteCollection(`artifacts/${appId}/users/${userId}/esgData`),
                    deleteCollection(`artifacts/${appId}/users/${userId}/esgGoals`),
                    deleteCollection(`artifacts/${appId}/users/${userId}/documents`),
                    deleteCollection(`artifacts/${appId}/users/${userId}/teamMembers`)
                ]);
                showToast('All application data has been cleared.');
            }
        } catch (error) {
            showToast('Failed to clear data.', 'error');
            console.error("Error clearing data:", error);
        } finally {
            modal.classList.add('hidden');
            currentDeletionTarget = null;
            itemToDeleteId = null;
            setButtonLoading(confirmDeleteBtn, false);
        }
    }

    // --- Event Listeners ---
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => { e.preventDefault(); showSection(e.currentTarget.dataset.section); });
    });

    chartToggles.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if(!button) return;
        chartToggles.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        renderAllDashboardElements();
    });

    settingsNav.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const tabId = button.dataset.settingsTab;
        settingsNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        settingsTabContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== `settings-tab-${tabId}`);
        });
    });

    saveProfileBtn.addEventListener('click', async () => {
        setButtonLoading(saveProfileBtn, true);
        userSettings.profile.firstName = firstNameInput.value;
        userSettings.profile.lastName = lastNameInput.value;
        userSettings.profile.bio = bioInput.value;
        try {
            await saveUserSettings();
            applySettings();
            showToast('Profile saved successfully!');
        } catch(e) {
            showToast('Failed to save profile.', 'error');
        } finally {
            setButtonLoading(saveProfileBtn, false);
        }
    });
    
    // START: Upgraded Password Change Logic
    passwordToggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
            const input = toggle.previousElementSibling;
            const icon = toggle.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });

    function checkPasswordStrength() {
        const password = newPasswordInput.value;
        const criteria = {
            length: password.length >= 8,
            lowercase: /[a-z]/.test(password),
            uppercase: /[A-Z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*]/.test(password),
        };

        let metCriteria = 0;
        for (const key in criteria) {
            const li = passwordCriteria.querySelector(`[data-criterion="${key}"]`);
            li.classList.toggle('text-green-500', criteria[key]);
            li.classList.toggle('dark:text-green-400', criteria[key]);
            if (criteria[key]) {
                metCriteria++;
            }
        }
        
        const strength = (metCriteria / 5) * 100;
        let strengthColor = 'bg-red-500';
        let strengthLabel = 'Weak';
        if (strength > 40 && strength <= 60) {
            strengthColor = 'bg-yellow-500';
            strengthLabel = 'Medium';
        } else if (strength > 60 && strength <= 80) {
            strengthColor = 'bg-blue-500';
            strengthLabel = 'Good';
        } else if (strength > 80) {
            strengthColor = 'bg-green-500';
            strengthLabel = 'Strong';
        }
        
        passwordStrengthBar.style.width = strength === 0 ? '0' : `${strength}%`;
        passwordStrengthBar.className = `h-2 rounded-full transition-all duration-300 ${strengthColor}`;
        passwordStrengthText.textContent = password.length > 0 ? strengthLabel : '';
        
        return metCriteria === 5;
    }

    function validateConfirmPassword() {
        const match = newPasswordInput.value === confirmPasswordInput.value && confirmPasswordInput.value.length > 0;
        confirmPasswordError.classList.toggle('hidden', match || confirmPasswordInput.value.length === 0);
        return match;
    }

    [forgotPasswordLinkLogin, forgotPasswordLinkSettings].forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            let email = document.getElementById('login-email').value;
            if (user && user.email) {
                email = user.email;
            }
            
            if (!email) {
                return showToast("Please enter an email address first.", "error");
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showToast(`Password reset link sent to ${email}!`, "success");
            } catch (error) {
                console.error("Forgot Password Error:", error);
                showToast("Failed to send password reset email. Please check the address.", "error");
            }
        });
    });

    newPasswordInput.addEventListener('input', () => {
        checkPasswordStrength();
        validateConfirmPassword();
    });
    confirmPasswordInput.addEventListener('input', validateConfirmPassword);
    
    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPass = document.getElementById('currentPassword').value;
        const newPass = newPasswordInput.value;
        
        if (!currentPass) return showToast('Please enter your current password.', 'error');
        if (!checkPasswordStrength()) return showToast('New password does not meet all criteria.', 'error');
        if (!validateConfirmPassword()) return showToast('New passwords do not match.', 'error');
        
        setButtonLoading(updatePasswordBtn, true);
        const user = auth.currentUser;
        if (!user || !user.email) {
            showToast("Password can't be changed for anonymous accounts.", "error");
            setButtonLoading(updatePasswordBtn, false);
            return;
        }
        const credential = EmailAuthProvider.credential(user.email, currentPass);

        try {
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPass);
            showToast('Password updated successfully!');
            changePasswordForm.reset();
            checkPasswordStrength();
            validateConfirmPassword();
        } catch (error) {
            console.error("Password Update Error:", error.code);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                showToast('Incorrect current password.', 'error');
            } else {
                showToast('Failed to update password. Please try again.', 'error');
            }
        } finally {
            setButtonLoading(updatePasswordBtn, false);
        }
    });

    updatePasswordBtn.addEventListener('click', () => {
        changePasswordForm.requestSubmit();
    });
    // END: Upgraded Password Change Logic


    notificationToggles.forEach(toggle => {
        toggle.addEventListener('click', async () => {
            const wasEnabled = toggle.classList.contains('enabled');
            toggle.classList.toggle('enabled');
            const key = toggle.dataset.notification;
            const isEnabled = !wasEnabled;
            userSettings.notifications[key] = isEnabled;
            try {
                await saveUserSettings();
                showToast('Notification settings updated.');
            } catch (e) {
                showToast('Failed to save settings.', 'error');
                // Revert visual state on error
                toggle.classList.toggle('enabled', wasEnabled);
                userSettings.notifications[key] = wasEnabled;
            }
        });
    });

    dangerZoneButtons.forEach(button => {
        button.addEventListener('click', () => {
            const target = button.dataset.deleteTarget;
            const messages = {
                timesheet: 'This will permanently delete all your Timesheet data.',
                esg: 'This will permanently delete all your ESG & Goal data.',
                all: 'This will permanently delete ALL your application data.'
            }
            openConfirmationModal(target, null, `${messages[target]} This action cannot be undone.`);
        });
    });

    confirmationInput.addEventListener('input', () => {
        confirmDeleteBtn.disabled = confirmationInput.value !== confirmationText.textContent;
    });
    
    async function handleSaveNoteClick(button) {
        const logId = button.dataset.id;
        const row = button.closest('tr');
        const input = row.querySelector('.note-input');
        const newNote = input.value;
        
        const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/timeLogs`, logId);
        try {
            await setDoc(logDocRef, { note: newNote }, { merge: true });
            showToast('Note updated successfully!');
        } catch (error) {
            showToast('Failed to update note.', 'error');
            console.error("Error updating note:", error);
        }
        // The onSnapshot listener will handle re-rendering the row back to its display state.
    }
    
    function handleEditNoteClick(button) {
        const row = button.closest('tr');
        const noteCell = row.querySelector('.note-cell');
        const currentNote = timeLog.find(log => log.id === button.dataset.id)?.note || '';
        
        noteCell.innerHTML = `
            <div class="flex items-center">
                <input type="text" value="${currentNote}" class="note-input form-input w-full p-1 text-sm">
                <button class="save-note-btn text-green-500 hover:text-green-700 ml-2" data-id="${button.dataset.id}">
                    <i class="fas fa-check"></i>
                </button>
            </div>
        `;
        noteCell.querySelector('.note-input').focus();
    }
    
    reportTableBody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-note-btn');
        const saveBtn = e.target.closest('.save-note-btn');
        const deleteBtn = e.target.closest('.delete-log-btn');

        if (editBtn) handleEditNoteClick(editBtn);
        if (saveBtn) handleSaveNoteClick(saveBtn);
        if (deleteBtn) {
            openConfirmationModal('singleLog', deleteBtn.dataset.id, "Are you sure you want to delete this time entry?", 'Delete Time Entry?', null);
        }
    });

    confirmDeleteBtn.addEventListener('click', handleConfirmDeletion);
    
    themeSelector.addEventListener('click', async (e) => {
        const button = e.target.closest('button.theme-option');
        if (!button) return;
        userSettings.theme = button.dataset.theme;
        document.documentElement.className = userSettings.theme;
        updateThemeButtons();
        await saveUserSettings();
        renderAllDashboardElements();
    });
    
    cancelDeleteBtn.addEventListener('click', () => modal.classList.add('hidden'));
    
    clockInOutBtn.addEventListener('click', handleClockInOut);
    prevMonthBtn.addEventListener('click', () => changeMonth(-1));
    nextMonthBtn.addEventListener('click', () => changeMonth(1));
    downloadCsvBtn.addEventListener('click', downloadCSV);
    esgForm.addEventListener('submit', handleEsgFormSubmit);
    reportGeneratorForm.addEventListener('submit', handleEsgReportGeneration);
    addFirstRecordBtn.addEventListener('click', () => showSection('data-entry'));

    // Goal Modal Listeners
    addGoalBtn.addEventListener('click', () => {
        goalForm.reset();
        document.getElementById('goal-id').value = '';
        goalModal.classList.remove('hidden');
    });
    cancelGoalBtn.addEventListener('click', () => goalModal.classList.add('hidden'));
    goalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const goalData = {
            metric: document.getElementById('goal-metric').value,
            target: document.getElementById('goal-target').value,
            deadline: document.getElementById('goal-deadline').value,
        };
        const goalsCollection = collection(db, `artifacts/${appId}/users/${userId}/esgGoals`);
        try {
            await addDoc(goalsCollection, goalData);
            showToast('Goal saved successfully!');
            goalModal.classList.add('hidden');
        } catch (error) {
            showToast('Failed to save goal.', 'error');
            console.error(error);
        }
    });

    goalsContainer.addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-goal-btn');
        if(deleteBtn) {
             openConfirmationModal('goal', deleteBtn.dataset.id, 'Are you sure you want to delete this goal?', 'Delete Goal', null);
        }
    });

    // Document Modal Listeners
    uploadDocBtn.addEventListener('click', () => {
        docUploadForm.reset();
        docUploadModal.classList.remove('hidden');
    });
    cancelUploadBtn.addEventListener('click', () => docUploadModal.classList.add('hidden'));
    docUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const docData = {
            name: document.getElementById('doc-name').value,
            category: document.getElementById('doc-category').value,
            uploadedAt: serverTimestamp()
        };
        const docsCollection = collection(db, `artifacts/${appId}/users/${userId}/documents`);
        try {
            await addDoc(docsCollection, docData);
            showToast('Document metadata saved!');
            docUploadModal.classList.add('hidden');
        } catch(error) {
            showToast('Failed to save document.', 'error');
            console.error(error);
        }
    });
    documentsTableBody.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-doc-btn');
        if (deleteBtn) {
            openConfirmationModal('document', deleteBtn.dataset.id, 'Are you sure you want to delete this document?', 'Delete Document', null);
        }
    });
    
    // AI Modal Listeners
    aiInsightsBtn.addEventListener('click', getAiInsights);
    closeAiModalBtn.addEventListener('click', () => aiInsightsModal.classList.add('hidden'));

    // Mobile Sidebar
    sidebarOpenBtn.addEventListener('click', () => {
        sidebar.classList.remove('-translate-x-full');
        sidebarOverlay.classList.remove('hidden');
    });
    [sidebarCloseBtn, sidebarOverlay].forEach(el => el.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }));

    // Team Management Listeners
    inviteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('invite-email').value;
        const role = document.getElementById('invite-role').value;
        if (!email) return;

        const teamCollection = collection(db, `artifacts/${appId}/users/${userId}/teamMembers`);
        try {
            await addDoc(teamCollection, { email, role });
            showToast('Team member invited successfully!');
            inviteForm.reset();
        } catch (error) {
            showToast('Failed to invite member.', 'error');
            console.error("Invite error:", error);
        }
    });

    teamList.addEventListener('click', async (e) => {
        const removeBtn = e.target.closest('.remove-member-btn');
        if(removeBtn) {
            openConfirmationModal('teamMember', removeBtn.dataset.id, 'Are you sure you want to remove this team member?', 'Remove Member', null);
        }
    });
    
    // --- AUTHENTICATION LOGIC ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in (either through login or anonymously)
            userId = user.uid;
            await loadUserSettings(); // Load settings for the current user
            setupDataListeners();
            
            // Only start app functions if the user is NOT anonymous OR if you want to allow anon users
            // For this app, we let anonymous users in to see the dashboard.
            // If they try to sign up/link, their data is preserved.
            
            setInterval(updateClock, 1000);
            updateClock();
            setDefaultReportDates();
            renderNewsFeed();
            
            loadingEl.classList.add('hidden');
            authContainer.classList.add('hidden');
            appContainerEl.classList.remove('hidden');
            appContainerEl.classList.add('flex');
            showSection('dashboard');

        } else {
            // User is signed out
            userId = null;
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            loadingEl.classList.add('hidden');
            appContainerEl.classList.add('hidden');
            authContainer.classList.remove('hidden');
        }
    });
    
    function toggleAuthMode(e) {
        if (e) e.preventDefault();
        const isSigningUp = loginForm.dataset.mode === 'signup';
        
        loginForm.dataset.mode = isSigningUp ? 'login' : 'signup';
        loginForm.querySelector('button[type="submit"]').textContent = isSigningUp ? 'Sign In' : 'Create Account';
        
        const linkContainer = loginForm.nextElementSibling;
        if (isSigningUp) {
            linkContainer.innerHTML = `Already have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign in</a>`;
        } else {
            linkContainer.innerHTML = `Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>`;
        }
        
        document.getElementById('show-signup').addEventListener('click', toggleAuthMode);
        setAuthError('');
    }
    
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const isSigningUp = loginForm.dataset.mode === 'signup';
        
        setAuthError('');
        
        try {
            if (isSigningUp) {
                if(password.length < 6) {
                    setAuthError("Password must be at least 6 characters long.");
                    return;
                }
                // Check if user is currently anonymous
                if(auth.currentUser && auth.currentUser.isAnonymous) {
                    // Link anonymous account to the new email/password
                    const credential = EmailAuthProvider.credential(email, password);
                    await linkWithCredential(auth.currentUser, credential);
                    showToast("Account created & data migrated!");
                } else {
                    // Or create a fresh new user
                    await createUserWithEmailAndPassword(auth, email, password);
                    showToast("Account created successfully!");
                }
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
            // onAuthStateChanged will handle UI switching
        } catch (error) {
            console.error("Auth Error:", error.code, error.message);
            let friendlyMessage = "An unknown error occurred. Please try again.";
            switch (error.code) {
                case 'auth/invalid-email':
                    friendlyMessage = "Please enter a valid email address.";
                    break;
                case 'auth/user-not-found':
                case 'auth/invalid-credential': // Catches both wrong email and password for security
                    friendlyMessage = "Incorrect email or password. Please try again.";
                    break;
                case 'auth/wrong-password':
                    friendlyMessage = "Incorrect password. Please try again.";
                    break;
                case 'auth/email-already-in-use':
                    friendlyMessage = "An account with this email already exists. Please sign in.";
                    break;
                case 'auth/weak-password':
                    friendlyMessage = "Password should be at least 6 characters long.";
                    break;
                 case 'auth/credential-already-in-use':
                    friendlyMessage = "This email is already linked to another account.";
                    break;
            }
            setAuthError(friendlyMessage);
        }
    });

    document.getElementById('show-signup').addEventListener('click', toggleAuthMode);
    
    logoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // --- INITIALIZATION ---
    (async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
            } catch (error) {
                console.error("Error signing in with custom token, falling back to anonymous:", error);
                if (!auth.currentUser) await signInAnonymously(auth);
            }
        } else if (!auth.currentUser) {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous Sign-In Error:", error);
                loadingEl.innerHTML = `<div class="text-center text-red-500 p-4">...</div>`;
            }
        }
        // onAuthStateChanged handles showing the app from here.
    })();

    document.addEventListener('DOMContentLoaded', function () {
    const tooltip = document.getElementById('global-tooltip');
    const linksWithTooltips = document.querySelectorAll('[data-tooltip]');

    linksWithTooltips.forEach(link => {
        // Show tooltip on mouse enter
        link.addEventListener('mouseenter', (event) => {
            const tooltipText = event.currentTarget.dataset.tooltip;
            if (!tooltipText) return;

            // Set the text
            tooltip.textContent = tooltipText;

            // Get the position of the icon/link
            const rect = event.currentTarget.getBoundingClientRect();
            
            // Position the tooltip
            // We use the tooltip's own size to center it perfectly
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = rect.top - tooltipRect.height - 8; // 8px gap above
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Apply the position
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            
            // Show the tooltip
            tooltip.classList.add('show');
        });

        // Hide tooltip on mouse leave
        link.addEventListener('mouseleave', () => {
            tooltip.classList.remove('show');
        });
    });
});


</script>
</body>
</html>

